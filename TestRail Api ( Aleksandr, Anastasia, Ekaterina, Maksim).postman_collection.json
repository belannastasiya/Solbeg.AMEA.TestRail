{
	"info": {
		"_postman_id": "458fc50f-cbbf-4c19-ab62-cddedc1946b2",
		"name": "TestRail Api ( Aleksandr, Anastasia, Ekaterina, Maksim)",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "Create issue in Jira",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"var jsonData = JSON.parse(responseBody);\r",
							"\r",
							"pm.test(\"Issue is created\", function () {\r",
							"    pm.response.to.have.status(201);\r",
							"});\r",
							"pm.collectionVariables.set(\"issueid\", jsonData.id);\r",
							"pm.collectionVariables.set(\"issuekey\", jsonData.key);\r",
							"pm.collectionVariables.set(\"issueself\", jsonData.self);\r",
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"auth": {
					"type": "basic",
					"basic": [
						{
							"key": "password",
							"value": "{{jira_pass}}",
							"type": "string"
						},
						{
							"key": "username",
							"value": "{{jira_user}}",
							"type": "string"
						}
					]
				},
				"method": "POST",
				"header": [
					{
						"key": "Accept",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\"fields\":\r\n    {\"project\": {\"key\": \"{{project_key}}\"},\r\n    \"priority\":{\"name\":\"{{name_priority}}\"},\r\n    \"{{team}}\":{\"name\":\"{{name_team}}\"},\r\n    \"{{story_points}}\":{\"name\":\"{{name_storyPoint}}\"},  \r\n    \"summary\": \"{{new_TR_name}}: run full regression testing\",\r\n    \"description\": {\r\n         \"type\": \"doc\",\r\n         \"version\": 1,\r\n         \"content\": [\r\n                { \"type\": \"paragraph\",\r\n                \"content\": [\r\n                    {\"text\": \"please see the report here:\",\r\n                     \"type\": \"text\"\r\n                    }  ]\r\n                }]},\r\n        \"{{acceptance_criteria}}\": {\r\n         \"type\": \"doc\",\r\n         \"version\": 1,\r\n         \"content\": [\r\n                { \"type\": \"paragraph\",\r\n                \"content\": [\r\n                    {\"text\": \"regression test is done, no critical issues are found\",\r\n                     \"type\": \"text\"\r\n                    }  ]\r\n                }]},\r\n    \"issuetype\": {\"name\": \"Task\"}\r\n        }\r\n    \r\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{jira_url}}/rest/api/3/issue",
					"host": [
						"{{jira_url}}"
					],
					"path": [
						"rest",
						"api",
						"3",
						"issue"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get run_id for old_TR_name",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"var jsonData = JSON.parse(responseBody);\r",
							"var oldTRname = pm.environment.get(\"old_TR_name\");\r",
							"for (run of jsonData.runs) {\r",
							"    if(run.name === oldTRname) {\r",
							"        pm.collectionVariables.set(\"run_id\", run.id);\r",
							"    }\r",
							"}\r",
							"pm.test(\"Can see TestRuns\", function () {\r",
							"    pm.response.to.have.status(200);\r",
							"});\r",
							"\r",
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"auth": {
					"type": "basic",
					"basic": [
						{
							"key": "password",
							"value": "{{TR_pass}}",
							"type": "string"
						},
						{
							"key": "username",
							"value": "{{TR_user}}",
							"type": "string"
						}
					]
				},
				"method": "GET",
				"header": [],
				"url": {
					"raw": "{{TR_url}}/api/v2/get_runs/{{projectID}}",
					"host": [
						"{{TR_url}}"
					],
					"path": [
						"api",
						"v2",
						"get_runs",
						"{{projectID}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Close Test Run with old name",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"TestRun is closed\", function () {\r",
							"    pm.response.to.have.status(200);\r",
							"});\r",
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [],
				"url": {
					"raw": "{{TR_url}}/api/v2/close_run/{{run_id}}",
					"host": [
						"{{TR_url}}"
					],
					"path": [
						"api",
						"v2",
						"close_run",
						"{{run_id}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get Case_ids with Regression type",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"var jsonData = JSON.parse(responseBody);\r",
							"var idList = []\r",
							"for (currentCase of jsonData.cases) {\r",
							"    if(currentCase.type === \"Regression\") {\r",
							"        idList.push(currentCase.id)\r",
							"    }\r",
							"}\r",
							"pm.collectionVariables.set(\"case_ids\", idList);\r",
							"\r",
							"pm.test(\"Can see Cases\", function () {\r",
							"    pm.response.to.have.status(200);\r",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"auth": {
					"type": "basic",
					"basic": [
						{
							"key": "password",
							"value": "{{TR_pass}}",
							"type": "string"
						},
						{
							"key": "username",
							"value": "{{TR_user}}",
							"type": "string"
						}
					]
				},
				"method": "GET",
				"header": [],
				"url": {
					"raw": "{{TR}}/api/v2/get_cases/{{projectID}}",
					"host": [
						"{{TR}}"
					],
					"path": [
						"api",
						"v2",
						"get_cases",
						"{{projectID}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Create new Test Run",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"New TestRun is added\", function () {\r",
							"    pm.response.to.have.status(200);\r",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"auth": {
					"type": "basic",
					"basic": [
						{
							"key": "password",
							"value": "{{TR_pass}}",
							"type": "string"
						},
						{
							"key": "username",
							"value": "{{TR_user}}",
							"type": "string"
						}
					]
				},
				"method": "POST",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"name\":\"{{new_TR_name}}\",\r\n    \"include_all\": false,\r\n    \"case_ids\": {{case_ids}},\r\n    \"refs\": \"{{issuekey}}\"\r\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{TR_url}}/api/v2/add_run/{{projectID}}",
					"host": [
						"{{TR_url}}"
					],
					"path": [
						"api",
						"v2",
						"add_run",
						"{{projectID}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get run_id for new_TR_name",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"var jsonData = JSON.parse(responseBody);\r",
							"var newTRname = pm.environment.get(\"new_TR_name\");\r",
							"for (run of jsonData.runs) {\r",
							"    if(run.name === newTRname) {\r",
							"        pm.collectionVariables.set(\"run_id_2\", run.id);\r",
							"    }\r",
							"}\r",
							"pm.test(\"Can see TestRuns\", function () {\r",
							"    pm.response.to.have.status(200);\r",
							"});\r",
							"\r",
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"auth": {
					"type": "basic",
					"basic": [
						{
							"key": "password",
							"value": "{{TR_pass}}",
							"type": "string"
						},
						{
							"key": "username",
							"value": "{{TR_user}}",
							"type": "string"
						}
					]
				},
				"method": "GET",
				"header": [],
				"url": {
					"raw": "{{TR_url}}/api/v2/get_runs/{{projectID}}",
					"host": [
						"{{TR_url}}"
					],
					"path": [
						"api",
						"v2",
						"get_runs",
						"{{projectID}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get Run_url for new_TR_name",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"var jsonData = JSON.parse(responseBody);\r",
							"\r",
							"if (responseCode.code === 200) {\r",
							"    tests[\"Got TestRun url\"] = responseBody.has(\"url\") === true;\r",
							"    pm.collectionVariables.set(\"R_url\", jsonData.url);\r",
							"}\r",
							"else {\r",
							"  tests[\"No url\"] = false;\r",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"auth": {
					"type": "basic",
					"basic": [
						{
							"key": "password",
							"value": "{{TR_pass}}",
							"type": "string"
						},
						{
							"key": "username",
							"value": "{{TR_user}}",
							"type": "string"
						}
					]
				},
				"method": "GET",
				"header": [],
				"url": {
					"raw": "{{TR_url}}/api/v2/get_run/{{run_id_2}}",
					"host": [
						"{{TR_url}}"
					],
					"path": [
						"api",
						"v2",
						"get_run",
						"{{run_id_2}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Link adding to jira",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Link is added\", function () {\r",
							"    pm.response.to.have.status(201);\r",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"object\": {\r\n        \"url\": \"{{R_url}}\",\r\n        \"title\": \"\"\r\n    }\r\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{jira_url}}/rest/api/3/issue/{{issueid}}/remotelink",
					"host": [
						"{{jira_url}}"
					],
					"path": [
						"rest",
						"api",
						"3",
						"issue",
						"{{issueid}}",
						"remotelink"
					]
				}
			},
			"response": []
		},
		{
			"name": "Version2 Add link Run_url to Jira",
			"request": {
				"auth": {
					"type": "basic",
					"basic": [
						{
							"key": "password",
							"value": "{{jira_pass}}",
							"type": "string"
						},
						{
							"key": "username",
							"value": "{{jira_user}}",
							"type": "string"
						}
					]
				},
				"method": "PUT",
				"header": [
					{
						"key": "Accept",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\"fields\":\r\n    {\"description\": {\r\n         \"type\": \"doc\",\r\n         \"version\": 1,\r\n         \"content\": [\r\n                { \"type\": \"paragraph\",\r\n                \"content\": [\r\n                    {\"text\": \"please see the report here:\",\r\n                     \"type\": \"text\"\r\n                    } ,\r\n                    {\"type\": \"text\",\r\n                      \"text\": \"   \"\r\n                    },\r\n                    {\"type\": \"inlineCard\",\r\n                     \"attrs\": {\"url\": \"{{R_url}}\"}\r\n                        } ]\r\n                }]}\r\n        }\r\n    \r\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{jira_url}}/rest/api/3/issue/{{issuekey}}",
					"host": [
						"{{jira_url}}"
					],
					"path": [
						"rest",
						"api",
						"3",
						"issue",
						"{{issuekey}}"
					]
				}
			},
			"response": []
		}
	],
	"variable": [
		{
			"key": "issueid",
			"value": ""
		},
		{
			"key": "issuekey",
			"value": ""
		},
		{
			"key": "issueself",
			"value": ""
		}
	]
}